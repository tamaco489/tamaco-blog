name: Security Scan

on:
  schedule:
    # Run every Monday at 9:00 AM JST
    - cron: "0 0 * * 1"
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "frontend/package*.json"
      - "backend/**/go.mod"
      - "backend/**/go.sum"

jobs:
  frontend-security:
    name: Frontend Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "🔍 Running security audit..."
          npm audit --json > audit-results.json || true

          # Check if there are any vulnerabilities
          VULNERABILITIES=$(cat audit-results.json | jq '.metadata.vulnerabilities.total // 0')

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "⚠️ Found $VULNERABILITIES vulnerabilities"
            npm audit
            echo "Please review and fix these vulnerabilities"
          else
            echo "✅ No vulnerabilities found"
          fi

      - name: Check for outdated packages
        run: |
          echo "📦 Checking for outdated packages..."
          npm outdated || true

      - name: Generate security report
        run: |
          echo "# Security Report - $(date)" > security-report.md
          echo "" >> security-report.md
          echo "## Audit Results" >> security-report.md
          npm audit --json | jq -r '.advisories // {} | to_entries[] | "- **\(.value.module_name)**: \(.value.title) (Severity: \(.value.severity))"' >> security-report.md || echo "No vulnerabilities found" >> security-report.md
          echo "" >> security-report.md
          echo "## Outdated Packages" >> security-report.md
          npm outdated --json | jq -r 'to_entries[] | "- **\(.key)**: Current \(.value.current) → Latest \(.value.latest)"' >> security-report.md || echo "All packages are up to date" >> security-report.md

          cat security-report.md

      - name: Upload frontend security report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-security-report
          path: frontend/security-report.md
          retention-days: 30

  backend-security:
    name: Backend Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend/api/article

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.6"
          cache-dependency-path: "backend/api/article/go.sum"

      - name: Download dependencies
        run: go mod download

      - name: Run govulncheck
        run: |
          echo "🔍 Running Go security vulnerability check..."
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > vuln-results.json || true

          # Check if there are any vulnerabilities
          VULNERABILITIES=$(cat vuln-results.json | jq -r '.message.symbol // empty' | wc -l)

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "⚠️ Found vulnerabilities in Go dependencies"
            govulncheck ./...
            echo "Please review and update vulnerable dependencies"
          else
            echo "✅ No vulnerabilities found in Go dependencies"
          fi

      - name: Check for outdated modules
        run: |
          echo "📦 Checking for outdated Go modules..."
          go list -u -m all | grep '\[' || echo "All modules are up to date"

      - name: Run Go static security analysis
        run: |
          echo "🔒 Running static security analysis..."
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./... || echo "Static analysis completed with warnings"

      - name: Generate backend security report
        run: |
          echo "# Backend Security Report - $(date)" > security-report.md
          echo "" >> security-report.md
          echo "## Vulnerability Scan Results" >> security-report.md

          if [ -f vuln-results.json ]; then
            echo "### govulncheck Results" >> security-report.md
            cat vuln-results.json | jq -r 'select(.message.symbol) | "- **\(.message.symbol)**: \(.message.text)"' >> security-report.md || echo "No vulnerabilities found" >> security-report.md
          fi

          echo "" >> security-report.md
          echo "## Outdated Modules" >> security-report.md
          go list -u -m all | grep '\[' | sed 's/^/- /' >> security-report.md || echo "All modules are up to date" >> security-report.md

          echo "" >> security-report.md
          echo "## Module Information" >> security-report.md
          echo "### Direct Dependencies" >> security-report.md
          go list -m all | grep -v '^github.com/tamaco489/tamaco-blog' | head -10 | sed 's/^/- /' >> security-report.md || echo "No external dependencies" >> security-report.md

          cat security-report.md

      - name: Upload backend security report
        uses: actions/upload-artifact@v4
        with:
          name: backend-security-report
          path: backend/api/article/security-report.md
          retention-days: 30
